name: News ingestion cron

on:
  workflow_dispatch:
    inputs:
      run:
        description: "Which run to execute"
        required: true
        type: choice
        options:
          - run1
          - run2
          - run3
          - run4

  schedule:
    # GitHub Actions cron uses UTC. You asked for EST (UTC-5) times.
    # We run at :07 to avoid top-of-hour scheduling contention.

    # Weekdays (Mon-Fri) in EST:
    # 07:07 EST -> 12:07 UTC (Mon-Fri)
    - cron: "7 12 * * 1-5"

    # 12:07 EST -> 17:07 UTC (Mon-Fri)
    - cron: "7 17 * * 1-5"

    # 17:07 EST -> 22:07 UTC (Mon-Fri)
    - cron: "7 22 * * 1-5"

    # 21:07 EST -> 02:07 UTC (next day)
    # To cover Mon-Fri 21:07 EST, this must run Tue-Sat in UTC.
    - cron: "7 2 * * 2-6"

    # Weekends (Sat/Sun): run2 only at 12:07 EST -> 17:07 UTC
    - cron: "7 17 * * 0,6"

concurrency:
  group: news-ingestion-cron
  cancel-in-progress: false

jobs:
  ingest:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    # Wire secrets once here; all steps inherit these env vars.
    env:
      CHATGPT_API_KEY: ${{ secrets.CHATGPT_API_KEY }}
      CHATGPT_MIDDLEWARE_ENABLED: ${{ secrets.CHATGPT_MIDDLEWARE_ENABLED }}
      CHATGPT_MODEL: ${{ secrets.CHATGPT_MODEL }}
      CHATGPT_REQUEST_DELAY_MS: ${{ secrets.CHATGPT_REQUEST_DELAY_MS }}
      CRON_SCHEDULE: ${{ secrets.CRON_SCHEDULE }}
      NEXT_PUBLIC_SANITY_DATASET: ${{ secrets.NEXT_PUBLIC_SANITY_DATASET }}
      NEXT_PUBLIC_SANITY_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_SANITY_PROJECT_ID }}
      NODE_ENV: ${{ secrets.NODE_ENV }}
      PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}
      PIXABAY_API_KEY: ${{ secrets.PIXABAY_API_KEY }}
      SANITY_API_READ_TOKEN: ${{ secrets.SANITY_API_READ_TOKEN }}
      SANITY_API_WRITE_TOKEN: ${{ secrets.SANITY_API_WRITE_TOKEN }}
      SANITY_GUNNER_ENABLED: ${{ secrets.SANITY_GUNNER_ENABLED }}
      WIKIMEDIA_USER_AGENT: ${{ secrets.WIKIMEDIA_USER_AGENT }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install deps
        run: npm ci

      # ---- Scheduled runs ----
      - name: Weekday run1 (7:07am EST)
        if: github.event_name == 'schedule' && github.event.schedule == '7 12 * * 1-5'
        run: npm run run:run1

      - name: Weekday run2 (12:07pm EST)
        if: github.event_name == 'schedule' && github.event.schedule == '7 17 * * 1-5'
        run: npm run run:run2

      - name: Weekday run3 (5:07pm EST)
        if: github.event_name == 'schedule' && github.event.schedule == '7 22 * * 1-5'
        run: npm run run:run3

      - name: Weekday run4 (9:07pm EST)
        # 9:07pm EST maps to 02:07 UTC next day (Tue-Sat in UTC)
        if: github.event_name == 'schedule' && github.event.schedule == '7 2 * * 2-6'
        run: npm run run:run4

      - name: Weekend run2 only (12:07pm EST)
        if: github.event_name == 'schedule' && github.event.schedule == '7 17 * * 0,6'
        run: npm run run:run2

      # ---- Manual runs (workflow_dispatch) ----
      - name: Manual run
        if: github.event_name == 'workflow_dispatch'
        run: npm run run:${{ inputs.run }}
